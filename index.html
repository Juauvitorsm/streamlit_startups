<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca de Empresas - Redesign</title>
    <!-- Carrega o Tailwind CSS CDN para um estilo moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configura√ß√£o de Fonte Inter */
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-left: 5px solid #3b82f6; background-color: #eff6ff; font-weight: 600; color: #1d4ed8; }
        .metric-value.none { color: #ef4444; } /* Cor vermelha para 'N√£o Respondeu' / 'Nenhum' */
        .metric-label { font-size: 0.85rem; }
    </style>
    <!-- Configura√ß√£o padr√£o do Firebase para conformidade do ambiente (MANTIDA) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // As vari√°veis globais __firebase_config e __initial_auth_token s√£o injetadas pelo ambiente.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token).catch(e => console.error("Firebase auth failed:", e));
            } else {
                signInAnonymously(auth).catch(e => console.error("Firebase anonymous auth failed:", e));
            }
        } else {
            console.warn("Firebase config not available. Running in standalone mode.");
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app" class="flex">
        <!-- Sidebar (Menu de Navega√ß√£o) -->
        <div id="sidebar" class="w-64 bg-white shadow-xl h-screen p-4 flex-shrink-0 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-8">üöÄ Painel Interativo</h2>
            <nav>
                <button onclick="navigate('Home')" id="nav-Home" class="w-full text-left py-3 px-4 mb-2 text-gray-700 hover:bg-gray-100 rounded-lg transition duration-150">
                    üè† Home
                </button>
                <button onclick="navigate('Listar Empresas')" id="nav-Listar Empresas" class="w-full text-left py-3 px-4 mb-2 text-gray-700 hover:bg-gray-100 rounded-lg transition duration-150">
                    üìÑ Listar Empresas
                </button>
                <button onclick="logout()" class="w-full text-left py-3 px-4 mt-8 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 9.414V17a1 1 0 01-1.414.707l-4-4A1 1 0 016 13V9.414L3.293 6.707A1 1 0 013 6V3zm2 3.414L7.414 8h5.172l2.414-2.586V4H5v2.414z" clip-rule="evenodd" /></svg>
                    Sair
                </button>
            </nav>
        </div>

        <!-- Conte√∫do Principal -->
        <main id="content" class="flex-grow p-4 md:p-8 overflow-y-auto">
            <!-- As p√°ginas (Login/Home/Listar Empresas/Dashboard) ser√£o renderizadas aqui -->
        </main>
    </div>

    <script>
        // Simula√ß√£o de vari√°veis globais e de configura√ß√£o do Streamlit/API
        const API_URL = "https://api.exemplo.com"; // Substitua pelo seu URL real da API
        const __app_id = 'default-app-id'; // ID da aplica√ß√£o (para ambiente Canvas)

        // Estado da Aplica√ß√£o (Simulando st.session_state)
        const appState = {
            token: '',
            selected_company_data: {},
            all_companies_data: null, // Cache para a lista completa
            home_page_search_results: null, // Resultados da busca r√°pida
            filtered_results: null, // Resultados do filtro da lista
            show_dashboard: false,
            form_type: 'login', // 'login' ou 'register'
            currentPage: 'Login',
            loading: false,
            message: { type: null, text: '' },
            // Estado para manter filtros na Listar Empresas
            search_term: '',
            selected_phase: 'Todas as Fases'
        };

        const contentDiv = document.getElementById('content');
        const sidebarDiv = document.getElementById('sidebar');

        // --- Utilidades e Mensagens ---
        function setLoading(isLoading) {
            appState.loading = isLoading;
            const loadingIndicator = document.getElementById('loading-indicator');
            if (isLoading) {
                if (!loadingIndicator) {
                    const div = document.createElement('div');
                    div.id = 'loading-indicator';
                    div.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50';
                    div.innerHTML = '<div class="px-8 py-4 bg-white rounded-lg shadow-2xl flex items-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Aguarde...</span></div>';
                    document.body.appendChild(div);
                }
            } else if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        function displayMessage(type, text) {
            appState.message = { type, text };
            render();
        }

        // --- API Calls (Simulando requests) ---

        async function apiCall(endpoint, method = 'GET', data = null, contentType = 'application/json') {
            setLoading(true);
            try {
                const headers = {
                    'Authorization': appState.token ? `Bearer ${appState.token}` : ''
                };
                
                const config = { method, headers };

                if (data) {
                    if (contentType === 'application/x-www-form-urlencoded') {
                        // Converte o objeto de dados para o formato URL-encoded (para o endpoint /token)
                        config.body = new URLSearchParams(data).toString();
                        headers['Content-Type'] = 'application/x-www-form-urlencoded';
                    } else if (method !== 'GET') {
                        config.body = JSON.stringify(data);
                        headers['Content-Type'] = 'application/json';
                    }
                }

                let url = `${API_URL}${endpoint}`;
                if (method === 'GET' && data) {
                    url += '?' + new URLSearchParams(data).toString();
                }
                
                // Simula√ß√£o de chamada de rede e backoff (apenas uma chamada para simplificar)
                const response = await fetch(url, config);

                if (!response.ok) {
                    let errorDetail = await response.text();
                    try { errorDetail = JSON.parse(errorDetail).detail; } catch (e) { /* ignore */ }
                    throw new Error(`Status ${response.status}: ${errorDetail || 'Erro desconhecido.'}`);
                }
                
                const responseData = await response.json();
                setLoading(false);
                return responseData;

            } catch (error) {
                setLoading(false);
                displayMessage('error', error.message || 'Erro de conex√£o com a API.');
                console.error("API Error:", error);
                throw error;
            }
        }

        async function fetchAllCompanies() {
            if (appState.all_companies_data) return;
            try {
                // Aqui estamos simulando a chamada inicial da Streamlit
                const data = await apiCall('/companies');
                appState.all_companies_data = data;
                render();
            } catch (e) {
                // Erro tratado em apiCall
            }
        }

        // --- Renderiza√ß√£o de Componentes ---

        function renderLogin() {
            // Esconde a sidebar na tela de login
            sidebarDiv.classList.add('hidden');
            contentDiv.className = 'flex-grow p-4 md:p-8 flex items-center justify-center';

            let messageHtml = '';
            if (appState.message.text) {
                const msgClass = appState.message.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
                messageHtml = `<div class="p-3 mb-4 rounded-lg ${msgClass} font-medium">${appState.message.text}</div>`;
                // Limpa a mensagem ap√≥s exibir
                setTimeout(() => { appState.message = { type: null, text: '' }; render(); }, 5000);
            }

            const loginForm = `
                <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-2xl">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                        ${appState.form_type === 'login' ? 'üîë Login' : 'üìù Criar Conta'}
                    </h2>
                    ${messageHtml}
                    <form id="auth-form">
                        <div class="mb-4">
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                            <input type="email" id="email" name="email" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                            <input type="password" id="password" name="password" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">
                            ${appState.form_type === 'login' ? 'Entrar' : 'Cadastrar'}
                        </button>
                    </form>
                    <button onclick="toggleFormType()" class="w-full mt-4 text-sm text-gray-500 hover:text-blue-600 transition duration-150">
                        ${appState.form_type === 'login' ? 'Criar nova conta' : 'J√° tem conta? üëâ Login'}
                    </button>
                </div>
            `;
            contentDiv.innerHTML = loginForm;

            document.getElementById('auth-form').onsubmit = async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;

                if (appState.form_type === 'login') {
                    // Login
                    try {
                        const data = await apiCall('/token', 'POST', { username: email, password: password }, 'application/x-www-form-urlencoded');
                        appState.token = data.access_token;
                        displayMessage('success', '‚úÖ Login realizado com sucesso!');
                        navigate('Home');
                    } catch (error) {
                        // Erro tratado em apiCall
                    }
                } else {
                    // Register
                    try {
                        await apiCall('/register', 'POST', { email, password });
                        displayMessage('success', 'Conta criada com sucesso! Fa√ßa login.');
                        appState.form_type = 'login';
                        render();
                    } catch (error) {
                        // Erro tratado em apiCall
                    }
                }
            };
        }

        function toggleFormType() {
            appState.form_type = appState.form_type === 'login' ? 'register' : 'login';
            render();
        }

        function closeDashboard() {
            appState.show_dashboard = false;
            // Volta para a p√°gina anterior (Home ou Lista)
            navigate(appState.currentPage); 
        }

        function renderDashboard(companyData) {
            contentDiv.className = 'flex-grow p-4 md:p-8 space-y-8';
            
            // Fun√ß√µes utilit√°rias para o template
            const noneClass = (value) => value === 'N√£o Respondeu' || value === 'Nenhum' || value === 'N/A' || !value ? 'metric-value none' : 'metric-value text-blue-600';
            const safeValue = (value) => value || 'N/A';

            const dashboardHtml = `
                <header class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <button onclick="closeDashboard()" class="text-blue-500 hover:text-blue-700 font-medium transition duration-150 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        Voltar para Lista
                    </button>
                    <h1 class="text-4xl font-extrabold text-gray-800">${safeValue(companyData.nome_da_empresa)}</h1>
                    <p class="text-gray-500 mt-1">ID da Empresa: ${safeValue(companyData.id)}</p>
                </header>

                <!-- Informa√ß√µes Gerais (M√©tricas) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${[
                        { label: "üöÄ Fase da Startup", key: 'fase_da_startup' },
                        { label: "üìÖ Ano de Funda√ß√£o", key: 'ano_de_fundacao' },
                        { label: "üë• Colaboradores", key: 'colaboradores' }
                    ].map(item => `
                        <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                            <p class="text-sm font-semibold text-gray-500 mb-1 metric-label">${item.label}</p>
                            <p class="text-2xl font-bold ${noneClass(companyData[item.key])}">${safeValue(companyData[item.key])}</p>
                        </div>
                    `).join('')}
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Coluna 1: Financeiras e Contato -->
                    <div class="lg:col-span-1 space-y-8">
                        <!-- Informa√ß√µes Financeiras (Design do Chat Anterior) -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center"><span class="mr-2 text-yellow-600">üí∞</span> Informa√ß√µes Financeiras</h2>
                            <div class="space-y-4">
                                ${[
                                    { label: "üìà Faturamento", key: 'faturamento' },
                                    { label: "üíµ Recebeu Investimento?", key: 'recebeu_investimento' },
                                    { label: "üåç Neg√≥cios no Exterior", key: 'negocios_no_exterior' }
                                ].map(item => `
                                    <div class="flex justify-between items-center border-b pb-2 last:border-b-0">
                                        <span class="text-gray-600 text-sm font-medium">${item.label}</span>
                                        <span class="font-bold text-base ${noneClass(companyData[item.key])}">${safeValue(companyData[item.key])}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Contato -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center"><span class="mr-2 text-green-600">üìë</span> Contato</h2>
                            <div class="space-y-3">
                                ${[
                                    { label: "Endere√ßo", key: 'endereco' },
                                    { label: "CNPJ", key: 'cnpj' },
                                    { label: "E-mail", key: 'email' },
                                    { label: "Site", key: 'site', isLink: true },
                                    { label: "Rede Social", key: 'rede_social' }
                                ].map(item => {
                                    const value = safeValue(companyData[item.key]);
                                    const displayValue = item.isLink && value !== 'N/A' ? `<a href="${value}" target="_blank" class="text-blue-500 hover:underline">${value}</a>` : value;
                                    return `
                                        <div>
                                            <span class="text-xs font-medium text-gray-500 block">${item.label}:</span>
                                            <span class="text-gray-800 font-medium">${displayValue}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Coluna 2: Modelo e Solu√ß√£o -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Modelo e Status -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center"><span class="mr-2 text-indigo-600">‚öôÔ∏è</span> Modelo e Status</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-10 gap-y-4">
                                ${[
                                    { label: "Setor Principal", key: 'setor_principal' },
                                    { label: "Setor Secund√°rio", key: 'setor_secundario' },
                                    { label: "P√∫blico Alvo", key: 'publico_alvo' },
                                    { label: "Modelo de Neg√≥cio", key: 'modelo_de_negocio' },
                                    { label: "Patente", key: 'patente' },
                                    { label: "J√° Pivotou?", key: 'ja_pivotou' },
                                    { label: "Comunidades", key: 'comunidades' }
                                ].map(item => `
                                    <div>
                                        <span class="text-sm font-medium text-gray-500 block">${item.label}:</span>
                                        <span class="text-gray-800 font-semibold">${safeValue(companyData[item.key])}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Solu√ß√£o (Destaque) -->
                        <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                            <h3 class="text-xl font-bold text-blue-700 mb-3 flex items-center"><span class="mr-2 text-2xl">üí°</span> Solu√ß√£o</h3>
                            <p class="text-gray-700 leading-relaxed">${safeValue(companyData.solucao)}</p>
                        </div>
                    </div>
                </div>
            `;
            contentDiv.innerHTML = dashboardHtml;
        }

        function viewDashboardFromSelection(selectId, dataArray) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement || dataArray.length === 0) {
                displayMessage('error', 'Nenhuma empresa selecionada para visualiza√ß√£o.');
                return;
            }

            const selectedCompanyName = selectElement.value;
            const selectedCompany = dataArray.find(c => c.nome_da_empresa === selectedCompanyName);

            if (selectedCompany) {
                appState.selected_company_data = selectedCompany;
                appState.show_dashboard = true;
                render();
            } else {
                 displayMessage('error', 'Erro ao encontrar dados da empresa selecionada.');
            }
        }

        function renderHomePage() {
            // Se estiver no dashboard, renderiza o dashboard e sai
            if (appState.show_dashboard) {
                renderDashboard(appState.selected_company_data);
                return;
            }
            
            // Exibe a sidebar
            sidebarDiv.classList.remove('hidden');
            contentDiv.className = 'flex-grow p-4 md:p-8 space-y-6 max-w-5xl mx-auto';

            const allPhases = (appState.all_companies_data || []).map(c => c.fase_da_startup).filter(Boolean);
            const uniquePhases = ["Todas as Fases", ...new Set(allPhases)].sort();
            
            const optionsHtml = uniquePhases.map(phase => `<option value="${phase}">${phase}</option>`).join('');

            let messageHtml = '';
            if (appState.message.text) {
                const msgClass = appState.message.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
                messageHtml = `<div class="p-3 mb-4 rounded-lg ${msgClass} font-medium">${appState.message.text}</div>`;
                // N√£o limpa a mensagem automaticamente aqui para que ela fique vis√≠vel na tela Home
            }

            let resultsHtml = '';
            if (appState.home_page_search_results) {
                const results = appState.home_page_search_results;
                if (results.length > 0) {
                    resultsHtml = `
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Resultados da Busca:</h3>
                            <div class="overflow-x-auto mb-4">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fase</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${results.map(comp => `
                                            <tr class="hover:bg-gray-50 transition duration-150">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${safeValue(comp.nome_da_empresa)}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${safeValue(comp.setor_principal)}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${safeValue(comp.fase_da_startup)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4">
                                <select id="select-company-home" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                                    ${results.map(comp => `<option value="${safeValue(comp.nome_da_empresa)}">${safeValue(comp.nome_da_empresa)}</option>`).join('')}
                                </select>
                                <button onclick="viewDashboardFromSelection('select-company-home', appState.home_page_search_results)" class="bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 transition duration-150 flex-shrink-0 w-full sm:w-auto">
                                    üìä Ver Dashboard
                                </button>
                            </div>
                        </div>
                    `;
                } else if (appState.home_page_search_results !== null) {
                    resultsHtml = '<div class="p-4 bg-yellow-100 text-yellow-700 rounded-lg">Nenhuma empresa encontrada com estes crit√©rios.</div>';
                }
            }


            contentDiv.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">üè† Home - Busca R√°pida de Empresas</h1>
                ${messageHtml}
                <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
                    <p class="text-gray-600">Digite uma palavra-chave ou filtre por fase da startup para uma busca otimizada na API.</p>
                    <form id="home-search-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-3">
                                <label for="query" class="block text-sm font-medium text-gray-700">üîç Pesquisar</label>
                                <input type="text" id="query" name="query" placeholder="Digite o nome, setor ou solu√ß√£o..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            </div>
                            <div class="md:col-span-1">
                                <label for="selected_phase" class="block text-sm font-medium text-gray-700">üöÄ Filtrar por Fase</label>
                                <select id="selected_phase" name="selected_phase" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                    ${optionsHtml}
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">
                            Buscar
                        </button>
                    </form>
                </div>
                ${resultsHtml}
            `;
            // Limpa a mensagem ap√≥s exibir
            if (appState.message.text) appState.message = { type: null, text: '' };


            document.getElementById('home-search-form').onsubmit = async (e) => {
                e.preventDefault();
                const query = e.target.query.value;
                const selected_phase = e.target.selected_phase.value;
                
                const params = {};
                if (query) params.query = query;
                if (selected_phase !== "Todas as Fases") params.fase = selected_phase;

                try {
                    const data = await apiCall('/optimized_search', 'GET', params);
                    appState.home_page_search_results = data;
                    displayMessage('success', `Encontramos ${data.length} empresas.`);
                } catch (e) {
                    appState.home_page_search_results = [];
                    render(); // For√ßa a renderiza√ß√£o para mostrar "Nenhuma empresa encontrada"
                    // Error handled by apiCall
                }
            };
        }

        function applyFilters(searchTerm, selectedPhase, allCompanies) {
            let filteredCompanies = allCompanies;

            if (selectedPhase !== "Todas as Fases") {
                filteredCompanies = filteredCompanies.filter(c => c.fase_da_startup === selectedPhase);
            }

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredCompanies = filteredCompanies.filter(c =>
                    (c.nome_da_empresa && c.nome_da_empresa.toLowerCase().includes(term)) ||
                    (c.setor_principal && c.setor_principal.toLowerCase().includes(term)) ||
                    (c.solucao && c.solucao.toLowerCase().includes(term))
                );
            }
            appState.filtered_results = filteredCompanies;
            render();
        }

        function renderListCompaniesPage() {
            if (appState.show_dashboard) {
                renderDashboard(appState.selected_company_data);
                return;
            }

            sidebarDiv.classList.remove('hidden');
            contentDiv.className = 'flex-grow p-4 md:p-8 space-y-6 max-w-5xl mx-auto';

            if (appState.all_companies_data === null) {
                contentDiv.innerHTML = '<div class="p-4 bg-blue-100 text-blue-700 rounded-lg">Carregando empresas...</div>';
                // Inicia o carregamento se ainda n√£o foi feito
                if (!appState.loading) fetchAllCompanies(); 
                return;
            }

            const allCompanies = appState.all_companies_data;
            const filteredCompanies = appState.filtered_results || allCompanies;
            
            const allPhases = allCompanies.map(c => c.fase_da_startup).filter(Boolean);
            const uniquePhases = ["Todas as Fases", ...new Set(allPhases)].sort();
            const optionsHtml = uniquePhases.map(phase => `<option value="${phase}">${phase}</option>`).join('');
            
            let resultsTableHtml = '';
            if (filteredCompanies.length > 0) {
                resultsTableHtml = `
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Exibindo ${filteredCompanies.length} empresas:</h3>
                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fase</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredCompanies.map(comp => `
                                    <tr class="hover:bg-gray-50 transition duration-150">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${safeValue(comp.nome_da_empresa)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${safeValue(comp.setor_principal)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${safeValue(comp.fase_da_startup)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4">
                        <select id="select-company-list" class="p-2 border border-gray-300 rounded-lg flex-grow w-full">
                            ${filteredCompanies.map(comp => `<option value="${safeValue(comp.nome_da_empresa)}">${safeValue(comp.nome_da_empresa)}</option>`).join('')}
                        </select>
                        <button onclick="viewDashboardFromSelection('select-company-list', appState.filtered_results)" class="bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 transition duration-150 w-full sm:w-auto">
                            üìä Ver Dashboard da Empresa
                        </button>
                    </div>
                `;
            } else {
                resultsTableHtml = '<div class="p-4 bg-yellow-100 text-yellow-700 rounded-lg">Nenhuma empresa encontrada com estes filtros.</div>';
            }


            contentDiv.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">üìÑ Lista de Empresas</h1>
                
                <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
                    <details id="filter-expander" class="group" ${appState.search_term || appState.selected_phase !== 'Todas as Fases' ? 'open' : ''}>
                        <summary class="flex justify-between items-center cursor-pointer text-lg font-medium text-blue-600 hover:text-blue-700">
                            <span>üîé Filtrar empresas</span>
                            <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </summary>
                        <div class="pt-4 border-t mt-4">
                            <form id="list-filter-form">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                    <div class="md:col-span-3">
                                        <label for="search_term" class="block text-sm font-medium text-gray-700">Pesquisar por nome, setor ou solu√ß√£o:</label>
                                        <input type="text" id="search_term" name="search_term" placeholder="Digite para filtrar..."
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                            value="${appState.search_term}">
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="filter_phase" class="block text-sm font-medium text-gray-700">Filtrar por Fase:</label>
                                        <select id="filter_phase" name="filter_phase" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                            ${optionsHtml}
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                                    Aplicar Filtros
                                </button>
                            </form>
                        </div>
                    </details>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    ${resultsTableHtml}
                </div>
            `;
            
            // Set initial filter state
            const filterPhaseSelect = document.getElementById('filter_phase');
            if (filterPhaseSelect) filterPhaseSelect.value = appState.selected_phase;

            document.getElementById('list-filter-form').onsubmit = (e) => {
                e.preventDefault();
                const searchTerm = e.target.search_term.value;
                const selectedPhase = e.target.filter_phase.value;
                
                appState.search_term = searchTerm;
                appState.selected_phase = selectedPhase;
                
                applyFilters(searchTerm, selectedPhase, allCompanies);
            };
        }

        function navigate(page) {
            if (page === 'Sair') {
                logout();
                return;
            }
            appState.currentPage = page;
            appState.show_dashboard = false; // Garante que o dashboard √© escondido ao trocar de p√°gina
            
            // Atualiza a classe ativa na sidebar
            document.querySelectorAll('#sidebar button').forEach(button => {
                button.classList.remove('tab-active');
            });
            const navButton = document.getElementById(`nav-${page}`);
            if (navButton) {
                navButton.classList.add('tab-active');
            }
            
            render();
        }

        function logout() {
            // Limpa o estado e volta para o login
            appState.token = '';
            appState.selected_company_data = {};
            appState.all_companies_data = null;
            appState.home_page_search_results = null;
            appState.filtered_results = null;
            appState.show_dashboard = false;
            appState.currentPage = 'Login';
            appState.message = { type: 'success', text: 'Sess√£o encerrada com sucesso.' };
            render();
        }

        function render() {
            if (!appState.token) {
                renderLogin();
            } else {
                if (appState.currentPage === 'Home') {
                    renderHomePage();
                } else if (appState.currentPage === 'Listar Empresas') {
                    renderListCompaniesPage();
                } else {
                    // Default para Home ap√≥s login
                    appState.currentPage = 'Home';
                    renderHomePage();
                }
            }
        }

        // --- Inicializa√ß√£o ---
        window.onload = function() {
            // Tenta pegar o token da URL (como no Streamlit)
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            if (urlToken) {
                appState.token = urlToken;
            } else {
                // Simula√ß√£o: Se o ambiente forneceu um token de auth, consideramos logado para o exemplo.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    appState.token = 'simulated-api-token-from-auth'; 
                }
            }
            
            // Define a p√°gina inicial se j√° estiver autenticado
            if (appState.token) {
                appState.currentPage = 'Home';
            }

            // Inicia o loop de renderiza√ß√£o
            render();
        };
    </script>
</body>
</html>
